# babel-plugin-transform-react-jsx插件源码解析

参考博客：https://juejin.cn/post/7186132321219641400#heading-5

这是一个Babel插件核心源码，负责将JSX语法转换为React.createElement调用或现代JSX运行时的jsx函数调用。以下是代码逻辑解析：

## 工具包积累

> babel所有相关包的介绍文档：https://github.com/babel/babel/blob/781e23e85e5c1b2165d4cfabcaf98c9ab699240a/packages/README.md

1. `@babel/helper-module-imports`：用于动态导入模块。
   1. 用于 在 Babel 插件中动态添加模块导入（import）语句。它的核心作用是帮助开发者在 AST（抽象语法树）中生成模块导入代码，而无需手动操作复杂的 AST 节点结构
   2. 在 Babel 插件开发中，当需要向用户代码中插入新的模块导入时（例如为 JSX 添加 React 依赖），可以使用 @babel/helper-module-imports 的 API 来完成。例如：
      1. 避免重复导入：如果模块已经存在导入语句，则不会重复添加
      2. addDefault：添加默认导入，例如 import React from'react'
      3. addNamed：添加命名导入，例如 import { useState } from'react'
      4. ensure：确保模块存在导入语句，例如 import React from'react'
      5. find：查找模块导入语句，例如 import React from'react'
2. `@babel/helper-annotate-as-pure`：用于标记函数为纯函数。
3. `@babel/plugin-syntax-jsx`: 用于添加JSX语法识别的标记开关。

## 源码解析

> 掘金个人总结：https://juejin.cn/post/7514325765754355750#heading-0

1. 经典模式
   1. 经典模式下：Babel 不负责导入函数，只做字符串替换
   2. 所以需要手动导入React.createElement函数，才能正常编译JSX，如使用注释or配置都会报错
      1. 例如：import React from'react'
   3. 历史原因：模块系统还不统一（CommonJS vs ES Modules），createElement函数有可能是不同的preact库提供的，且每个库的模块导出语法可能不同，无法简单的引入cre函数，为了灵活性和兼容性，React 团队决定让开发者 显式引入 React
2. 自动模式
   1. 自动模式下，JSX 编译器（如 Babel 插件 @babel/plugin-transform-react-jsx）根据 @jsxRuntime automatic 注释或插件配置，自动生成对 jsx 和 jsxs 函数的导入语句，而无需手动导入。
      1. 这些函数通常位于模块的 jsx-runtime 文件中（如 React 的 react/jsx-runtime
      2. 
      ```js
      /** @jsxRuntime automatic */
      /** @jsxImportSource react */
      const App = () => <div>Hello</div>;
      // 编译后
      import { jsx as _jsx } from "react/jsx-runtime";
      const App = () => _jsx("div", { children: "Hello" });
      ```
   2. 自动模式引入了两个专门用于 JSX 元素生成的函数：jsx 和 jsxs
      1. jsx：用于生成单个子节点的 JSX 元素。
      2. jsxs：用于生成多个子节点的 JSX 元素，允许在某些情况下进行优化（如减少对象分配）
   3. 改进：在自动模式下，React 提供了一个专门的模块 jsx-runtime，该模块包含了处理 JSX 元素所需的所有函数（如 jsx 和 jsxs）。Babel 插件可以根据配置或注释自动生成对这些函数的导入语句

### 流程

1. JSX代码
   1. 解析模式
      1. classic：使用React.createElement函数
         1. 处理属性/子元素
      2. automatic：使用jsx函数
         1. 处理props对象
   2. 最终生成函数调用表达式
      1. 例如：React.createElement('div', { className: 'test' }, 'Hello, world!')

