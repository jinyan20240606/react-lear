# 视频背景自动取色Demo

这个项目实现了一个视频播放器，能够自动提取视频边缘区域的颜色，并将其应用为背景色，解决了视频比例不兼容时黑边的问题。

## 功能特点

- **自动取色**：从视频帧实时提取边缘颜色
- **平滑过渡**：颜色变化时有平滑的过渡效果
- **性能优化**：自适应采样间隔，保持流畅体验
- **边缘区域分析**：分别分析四个边缘区域，获取更精准的背景色

## 实现原理

### 聚类算法版本 (script-cluster.js)

1. **Lab色彩空间聚类**：
   - 将RGB颜色转换为Lab色彩空间，更符合人眼感知
   - 基于Lab空间距离进行颜色聚类，相似颜色归为一组
   - 提取每个簇的主要颜色作为代表色

2. **边缘区域分析**：
   - 分别提取视频四边（左、右、上、下）的颜色
   - 对每个边缘区域单独进行聚类分析
   - 综合四边颜色信息，生成更自然的背景效果

3. **性能优化**：
   - 使用采样间隔减少处理的像素数量
   - 限制颜色分析的频率，避免过度消耗CPU
   - 实时监控FPS，动态调整采样参数

4. **视觉效果增强**：
   - 使用CSS渐变和模糊效果创建自然过渡
   - 实现背景色的平滑动画过渡
   - 支持半透明效果，增强视觉体验

### 颜色处理流程

```
视频帧 → Canvas绘制 → 像素数据提取 → RGB转Lab → 颜色聚类 → 
边缘区域分析 → 主色提取 → 平滑过渡 → 应用背景色
```

## 使用方法

1. 打开`index-cluster.html`文件
2. 点击"选择视频文件"按钮上传本地视频
3. 视频开始播放后，背景将自动根据视频内容变化

## 文件说明

- `index-cluster.html`: 聚类算法版本的HTML界面
- `script-cluster.js`: 基于Lab色彩空间的聚类算法实现
- `style-cluster.css`: 支持颜色过渡和边缘区域显示的样式表

## 技术细节

### Lab色彩空间

Lab色彩空间是一种知觉均匀的色彩空间，其中欧几里得距离与人类感知的颜色差异更一致。使用Lab空间进行聚类可以获得更符合人眼感知的颜色分组。

### 聚类算法

本项目使用基于距离阈值的简化聚类算法：
1. 遍历像素点，转换为Lab空间
2. 计算与现有簇的距离，如果小于阈值，加入该簇
3. 如果没有合适的簇，创建新簇
4. 计算每个簇的平均颜色作为代表色

### 性能考量

- 使用`willReadFrequently: true`优化Canvas性能
- 采用定时分析而非每帧分析，减少CPU负载
- 实现自适应采样间隔，根据FPS动态调整

## 浏览器兼容性

- 支持现代浏览器（Chrome、Firefox、Safari、Edge）
- 需要支持Canvas API和requestAnimationFrame
- 部分效果（如backdrop-filter）在旧浏览器中可能不可用

## 个人遇到的问题积累

1. 需要边界判断颜色的深浅：文字为白色时，背景色过浅，则会影响文字的展示效果
2. 边缘黑色白色需要过滤：视频的黑色和白色边缘会影响背景色的选择，需要过滤掉
3. 颜色过渡平滑：背景色的过渡需要平滑，避免突变
4. 颜色的亮度和饱和度需要控制：背景色的亮度和饱和度需要控制，避免过亮或过暗
5. canvas获取数据跨域问题：
   1. canvas获取图像数据跨域问题，需要使用Blob对象进行跨域访问
   2. videodemo/autohue.ts的loadImage
6. LAB空间最大距离，最小距离是0
   1. 阈值怎么控制，合理的范围
   2. 初始簇的选定，什么策略
```js
// 定义 Lab 空间的最远对角颜色
const lab1 = [0, -128, -128];
const lab2 = [100, 127, 127];

// 计算最大距离
const maxDistance = labDistance(lab1, lab2);
console.log('Lab 空间的最大距离:', maxDistance);
 Lab 空间的最大距离: 374.2325480232846
```    

## 演讲素材

1. 图片取色算法主要用于从图像中提取主要颜色。有许多不同的算法可以实现这个目标
2. 色彩空间的选择，为什么选择LAB
3. 提取算法的选择，实现对比为什么选择聚类算法
4. 为什么不使用现成的库？ 没有符合需求的，要求自定义边界提取，即如何处理边缘颜色
5. 预处理
   1. 降采样
   2. 将噪
   3. 降采样 (Downsampling) 👨🍳
      好比切配食材时把整块肉切成肉丁
      作用：降低数据量（如将4096x2160图像缩小到1024x540）
      技术手段：双线性插值、最近邻算法
      降噪 (Denoising) 🔊
      类似过滤汤汁中的杂质
      作用：消除随机噪声（如高斯噪声、椒盐噪声）
      技术手段：高斯模糊、中值滤波
      去皮 (Background Removal) 🎭
      像剥去洋葱外皮保留可食用部分
      作用：分离主体与背景
      技术手段：阈值分割、边缘检测

### 技术API理解

1. canvasimageData.data 是一个 一维数组，类型是 Uint8ClampedArray。
它包含了图像中每个像素的 RGBA 信息（红、绿、蓝、透明度），每四个值代表一个像素
   1. 假设图片是 2x2 像素，那么 data 数组会有 2 * 2 * 4 = 16 个元素
   2. 
   ```js
      const data = [
        R1, G1, B1, A1,   // 第一个像素
        R2, G2, B2, A2,   // 第二个像素
        R3, G3, B3, A3,
        R4, G4, B4, A4
      ];
   ```
   ![alt text](image.png)
2. 卷积
   1. 对于图像的每一个像素点，计算它的邻域像素和滤波器矩阵的对应元素的乘积，然后加起来，作为该像素位置的值，图像像素点不变，3x3矩阵计算后得到的结果只替换中间那个点的值，其他不变，图像降噪中相当于把噪峰这个峰点磨平了，看起来模糊了，  